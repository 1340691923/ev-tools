import{b as K,c as ne,d as se,e as re,f as ue,g as ie,h as pe}from"./es-backup-391cdd1c.js";import{g as P,b,f as Q,r as i,o as C,c as T,a as e,w as l,h,t as _,F as W,q as X,s as I,H as Z,E as $,k as M,N as z,O as de,e as ce,j as J,x as F,u as Y}from"./index-a7681215.js";import{I as x}from"./select-d6e67766.js";import{d as me}from"./es-index-98bfea11.js";import{J as be}from"./index-ada9636d.js";import"./_plugin-vue_export-helper-c27b6911.js";function q(S){var f=new Date(S*1e3);const g=f.getFullYear()+"-",w=(f.getMonth()+1<10?"0"+(f.getMonth()+1):f.getMonth()+1)+"-",u=H(f.getDate())+" ",V=H(f.getHours())+":",d=H(f.getMinutes())+":",k=H(f.getSeconds());return g+w+u+V+d+k}function H(S){return S<10?"0"+S:S}const fe={__name:"addSnapshot",props:{open:{type:Boolean,default:!1},snapshotData:{type:Object,default:null}},emits:["close"],setup(S,{emit:f}){P().appContext.config.globalProperties;const w=b(S.open);b(!1);const u=b({snapshotName:"",repositoryName:"",indexList:[],ignore_unavailable:null,include_global_state:null,partial:null,wait:null}),V=b({}),d=b(!1),k=t=>{console.log(t),u.value.indexList=t},G=async()=>{d.value=!0;const t={es_connect:I.GetSelectEsConnID()},{data:r,code:s,msg:c}=await K(t);s===0?V.value=r.res:s===199999?Z({title:"Error",dangerouslyUseHTMLString:!0,message:`
        <strong>
          <i style="color: orange">path.repo没有设置</i><br>
          <i>在elasticsearch.yml 配置文件中配置仓库base目录</i><br>
          <i>添加path.repo: /tmp/tmp (/tmp/tmp 为快照备份所在文件夹, <br><i style="color: orange">注意</i>首先要先创建这个文件夹)</i>
        </strong>
      `,type:"error"}):$({type:"error",message:c}),d.value=!1},N=()=>{n("close",!1)},L=async()=>{const t={...u.value,es_connect:I.GetSelectEsConnID()},{code:r,msg:s}=await ne(t);r===0?(n("close",!0),$({type:"success",message:s})):$({type:"error",message:s})},n=f;return Q(()=>{G()}),(t,r)=>{const s=i("el-option"),c=i("el-select"),y=i("el-form-item"),U=i("el-input"),R=i("el-form"),A=i("el-button"),a=i("el-card"),o=i("el-drawer");return C(),T("div",null,[e(o,{size:"80%",modelValue:w.value,"onUpdate:modelValue":r[5]||(r[5]=p=>w.value=p),title:t.$t("创建快照"),onClose:N},{default:l(()=>[e(a,{class:"box-card"},{footer:l(()=>[e(A,{type:"danger",onClick:N},{default:l(()=>[h(_(t.$t("取消")),1)]),_:1}),e(A,{type:"primary",onClick:L},{default:l(()=>[h(_(t.$t("确认")),1)]),_:1})]),default:l(()=>[e(R,{"label-width":"500px","label-position":"left"},{default:l(()=>[e(y,{label:t.$t("存储库")},{default:l(()=>[e(c,{modelValue:u.value.repositoryName,"onUpdate:modelValue":r[0]||(r[0]=p=>u.value.repositoryName=p),clearable:"",filterable:"",placeholder:t.$t("请选择存储库")},{default:l(()=>[(C(!0),T(W,null,X(V.value,(p,v,E)=>(C(),M(s,{key:E,label:v,value:v},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),e(y,{label:t.$t("快照名")},{default:l(()=>[e(U,{modelValue:u.value.snapshotName,"onUpdate:modelValue":r[1]||(r[1]=p=>u.value.snapshotName=p),placeholder:t.$t("快照名")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(y,{label:t.$t("需要备份的索引")},{default:l(()=>[e(x,{multiple:!0,"have-all":!0,clearable:!0,style:{width:"210px"},placeholder:t.$t("需要备份的索引"),onChange:k},null,8,["placeholder"])]),_:1},8,["label"]),e(y,{label:t.$t("include_global_state 【通过设置 include_global_state 为false 能够防止 集群的全局状态被作为快照的一部分存储起来】")},{default:l(()=>[e(c,{modelValue:u.value.include_global_state,"onUpdate:modelValue":r[2]||(r[2]=p=>u.value.include_global_state=p),filterable:""},{default:l(()=>[e(s,{label:t.$t("不设置"),value:null},null,8,["label"]),e(s,{label:t.$t("是"),value:!0},null,8,["label"]),e(s,{label:t.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(y,{label:t.$t("partial  【如果快照中的1个或多个索引不是全部主分片都可用，就会导致整个创建快照的过程失败。 通过设置 partial 为 true 可以改变这个行为】")},{default:l(()=>[e(c,{modelValue:u.value.partial,"onUpdate:modelValue":r[3]||(r[3]=p=>u.value.partial=p),clearable:"",filterable:""},{default:l(()=>[e(s,{label:t.$t("不设置"),value:null},null,8,["label"]),e(s,{label:t.$t("是"),value:!0},null,8,["label"]),e(s,{label:t.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(y,{label:t.$t("创建方式")},{default:l(()=>[e(c,{modelValue:u.value.wait,"onUpdate:modelValue":r[4]||(r[4]=p=>u.value.wait=p),clearable:"",filterable:""},{default:l(()=>[e(s,{label:t.$t("不设置"),value:null},null,8,["label"]),e(s,{label:t.$t("异步创建"),value:!0},null,8,["label"]),e(s,{label:t.$t("同步创建"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])}}},ve={__name:"snapshotRestore",props:{open:{type:Boolean,default:!1},snapshot:{type:String,default:""},repository:{type:String,default:""}},emits:["close"],setup(S,{emit:f}){P().appContext.config.globalProperties;const g=S,w=b(g.snapshot),u=b(g.repository),V=b(g.open);b(!1);const d=b({snapshotName:g.snapshot,repositoryName:g.repository,ignore_unavailable:null,include_global_state:null,partial:null,wait:null,indexList:[],rename_pattern:"",rename_replacement:""}),k=n=>{d.value.indexList=n},G=()=>{L("close",!1)},N=async()=>{const n={...d.value,es_connect:I.GetSelectEsConnID()},{code:t,msg:r}=await se(n);if(t===0){L("close",!0),$({type:"success",message:r});return}r.includes(" with same name already exists ")?de.confirm(`错误信息:【${r}】,是否先关闭所有索引再进行恢复快照?`,"警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{const s={es_connect:I.GetSelectEsConnID(),index_name:"*"},c=await me(s);if(c.code!==0){$({type:"error",message:c.msg});return}await N()}).catch(s=>{console.error(s)}):$({type:"error",message:r})},L=f;return z(()=>g.snapshot,n=>{d.value.snapshotName=n}),z(()=>g.repository,n=>{d.value.repositoryName=n}),(n,t)=>{const r=i("el-input"),s=i("el-form-item"),c=i("el-option"),y=i("el-select"),U=i("el-form"),R=i("el-button"),A=i("el-card"),a=i("el-drawer");return C(),T("div",null,[e(a,{size:"80%",modelValue:V.value,"onUpdate:modelValue":t[7]||(t[7]=o=>V.value=o),title:n.$t("恢复备份"),onClose:G},{default:l(()=>[e(A,{class:"box-card"},{footer:l(()=>[e(R,{type:"danger",onClick:G},{default:l(()=>[h(_(n.$t("取消")),1)]),_:1}),e(R,{type:"primary",onClick:N},{default:l(()=>[h(_(n.$t("确认")),1)]),_:1})]),default:l(()=>[e(U,{"label-width":"500px","label-position":"left"},{default:l(()=>[e(s,{label:n.$t("仓库名")},{default:l(()=>[e(r,{modelValue:u.value,"onUpdate:modelValue":t[0]||(t[0]=o=>u.value=o),readonly:""},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("快照名")},{default:l(()=>[e(r,{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=o=>w.value=o),readonly:""},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("需要恢复的索引")},{default:l(()=>[e(x,{multiple:!0,"have-all":!0,clearable:!0,style:{width:"210px"},placeholder:n.$t("需要恢复的索引"),onChange:k},null,8,["placeholder"])]),_:1},8,["label"]),e(s,{label:n.$t("rename_pattern 【正则表达式】")},{default:l(()=>[e(r,{modelValue:d.value.rename_pattern,"onUpdate:modelValue":t[2]||(t[2]=o=>d.value.rename_pattern=o)},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("rename_replacement 【正则表达式】")},{default:l(()=>[e(r,{modelValue:d.value.rename_replacement,"onUpdate:modelValue":t[3]||(t[3]=o=>d.value.rename_replacement=o)},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("include_global_state 【通过设置 include_global_state 为false 能够防止 集群的全局状态被作为快照的一部分存储起来】")},{default:l(()=>[e(y,{modelValue:d.value.include_global_state,"onUpdate:modelValue":t[4]||(t[4]=o=>d.value.include_global_state=o),filterable:""},{default:l(()=>[e(c,{label:n.$t("不设置"),value:null},null,8,["label"]),e(c,{label:n.$t("是"),value:!0},null,8,["label"]),e(c,{label:n.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("partial  【如果快照中的1个或多个索引不是全部主分片都可用，就会导致整个创建快照的过程失败。 通过设置 partial 为 true 可以改变这个行为】")},{default:l(()=>[e(y,{modelValue:d.value.partial,"onUpdate:modelValue":t[5]||(t[5]=o=>d.value.partial=o),clearable:"",filterable:""},{default:l(()=>[e(c,{label:n.$t("不设置"),value:null},null,8,["label"]),e(c,{label:n.$t("是"),value:!0},null,8,["label"]),e(c,{label:n.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("创建方式")},{default:l(()=>[e(y,{modelValue:d.value.wait,"onUpdate:modelValue":t[6]||(t[6]=o=>d.value.wait=o),clearable:"",filterable:""},{default:l(()=>[e(c,{label:n.$t("不设置"),value:null},null,8,["label"]),e(c,{label:n.$t("异步创建"),value:!0},null,8,["label"]),e(c,{label:n.$t("同步创建"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])}}},ge={class:"app-container"},_e={class:"search-container"},Se={__name:"snapshot",setup(S){P().appContext.config.globalProperties;const f=b(!1),g=b(!1),w=b(!1),u=b(""),V=b({}),d=b(""),k=b(!1),G=b([]),N=b(""),L=ce(()=>JSON.stringify(N.value,null,"	")),n=()=>{f.value=!1},t=async a=>{const o={es_connect:I.GetSelectEsConnID(),snapshot:a,repository:u.value},{data:p,code:v,msg:E}=await ue(o);if(v!==0){$.error(E);return}N.value=p.snapshots,k.value=!0,$.success(E)},r=a=>{d.value=a,f.value=!0},s=async a=>{const o={es_connect:I.GetSelectEsConnID(),snapshot:a,repository:u.value},{code:p,msg:v}=await ie(o);if(p!==0){$.error(v);return}y(),U(),$.success(v)},c=a=>{g.value=!1,a&&(y(),U())},y=async()=>{w.value=!0;const a={es_connect:I.GetSelectEsConnID()},{data:o,code:p,msg:v}=await K(a);if(p===0)V.value=o.res,Object.keys(V.value).length>0&&(u.value=Object.keys(V.value)[0]),U();else if(p===199999){Z({title:"Error",dangerouslyUseHTMLString:!0,message:`
        <strong>
          <i style="color: orange">path.repo没有设置</i><br>
          <i>在elasticsearch.yml 配置文件中配置仓库base目录</i><br>
          <i>添加path.repo: /tmp/tmp (/tmp/tmp 为快照备份所在文件夹, <br><i style="color: orange">注意</i>首先要先创建这个文件夹)</i>
        </strong>
      `,type:"error"}),w.value=!1;return}else $.error(v);w.value=!1},U=async()=>{const a={es_connect:I.GetSelectEsConnID(),repository:u.value},{data:o,code:p,msg:v}=await re(a);if(p!==0){$.error(v);return}$.success(v),G.value=o},R=async a=>{d.value=a;const o={es_connect:I.GetSelectEsConnID(),repository:u.value,snapshot:a},{data:p,code:v,msg:E}=await pe(o);if(v!==0){$.error(E);return}N.value=p.snapshots,k.value=!0},A=a=>{a()};return Q(()=>{y()}),(a,o)=>{const p=i("el-option"),v=i("el-select"),E=i("el-form-item"),B=i("el-button"),ee=i("el-form"),D=i("el-table-column"),j=i("el-tag"),le=i("el-button-group"),te=i("el-table"),ae=i("el-drawer");return C(),T("div",ge,[J("div",_e,[e(ee,{inline:!0},{default:l(()=>[e(E,null,{default:l(()=>[e(v,{modelValue:u.value,"onUpdate:modelValue":o[0]||(o[0]=m=>u.value=m),clearable:"",filterable:"",style:{width:"200px"},placeholder:a.$t("请选择存储库"),loading:w.value,onChange:U},{default:l(()=>[(C(!0),T(W,null,X(V.value,(m,O,oe)=>(C(),M(p,{key:oe,label:O,value:O},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1}),e(E,null,{default:l(()=>[e(B,{type:"warning",onClick:o[1]||(o[1]=m=>g.value=!0)},{default:l(()=>[h(_(a.$t("新建快照")),1)]),_:1}),e(B,{type:"success",onClick:U},{default:l(()=>[h(_(a.$t("刷新")),1)]),_:1})]),_:1})]),_:1})]),e(te,{data:G.value},{default:l(()=>[e(D,{align:"center",label:a.$t("快照名"),prop:"id"},null,8,["label"]),e(D,{align:"center",label:a.$t("备份索引数"),prop:"indices",width:"100"},null,8,["label"]),e(D,{align:"center",label:a.$t("状态"),width:"100"},{default:l(m=>[m.row.status=="SUCCESS"?(C(),M(j,{key:0,type:"success"},{default:l(()=>[h(_(a.$t("成功")),1)]),_:1})):m.row.status=="IN_PROGRESS"?(C(),M(j,{key:1,type:"warning"},{default:l(()=>[h(_(a.$t("还在进行中")),1)]),_:1})):(C(),M(j,{key:2},{default:l(()=>[h(_(m.row.status),1)]),_:2},1024))]),_:1},8,["label"]),e(D,{align:"center",label:a.$t("开始详细时间"),width:"180"},{default:l(m=>[J("div",null,_(Y(q)(m.row.start_epoch)),1)]),_:1},8,["label"]),e(D,{align:"center",label:a.$t("结束详细时间"),width:"180"},{default:l(m=>[J("div",null,_(Y(q)(m.row.end_epoch)),1)]),_:1},8,["label"]),e(D,{align:"center",label:a.$t("耗费时长"),prop:"duration",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("分片总数"),prop:"total_shards",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("成功分片数"),prop:"successful_shards",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("失败分片数"),prop:"failed_shards",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("操作"),fixed:"right",width:"350"},{default:l(m=>[e(le,null,{default:l(()=>[e(B,{type:"success",onClick:O=>R(m.row.id)},{default:l(()=>[h(_(a.$t("查看")),1)]),_:2},1032,["onClick"]),e(B,{type:"danger",onClick:O=>s(m.row.id)},{default:l(()=>[h(_(a.$t("删除")),1)]),_:2},1032,["onClick"]),e(B,{type:"warning",onClick:O=>r(m.row.id)},{default:l(()=>[h(_(a.$t("恢复")),1)]),_:2},1032,["onClick"]),e(B,{type:"primary",onClick:O=>t(m.row.id)},{default:l(()=>[h(_(a.$t("状态")),1)]),_:2},1032,["onClick"])]),_:2},1024)]),_:1},8,["label"])]),_:1},8,["data"]),e(ae,{ref:"drawer",title:a.$t("快照详细信息"),"before-close":A,modelValue:k.value,"onUpdate:modelValue":o[3]||(o[3]=m=>k.value=m),direction:"rtl","close-on-press-escape":"","destroy-on-close":"",size:"80%"},{default:l(()=>[e(be,{value:L.value,"onUpdate:value":o[2]||(o[2]=m=>L.value=m),class:"res-body",styles:"width: 100%",read:!0,title:a.$t("快照详细信息")},null,8,["value","title"])]),_:1},8,["title","modelValue"]),g.value?(C(),M(fe,{key:0,open:g.value,onClose:c},null,8,["open"])):F("",!0),f.value?(C(),M(ve,{key:1,repository:u.value,snapshot:d.value,open:f.value,onClose:n},null,8,["repository","snapshot","open"])):F("",!0)])}}};export{Se as default};
