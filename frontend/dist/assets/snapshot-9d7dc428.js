import{a as z,b as ae,c as oe,d as ne,e as se,f as ue,g as re}from"./es-backup-ee2662f1.js";import{g as P,b as m,f as K,r as u,o as S,c as G,a as e,w as t,F as Q,q as W,h as E,i as h,t as g,s as L,H as X,E as k,k as B,N as J,O as ie,e as pe,x as Y,u as H}from"./index-1032a0df.js";import{d as de}from"./es-index-3002c717.js";function q(N){var f=new Date(N*1e3);const _=f.getFullYear()+"-",V=(f.getMonth()+1<10?"0"+(f.getMonth()+1):f.getMonth()+1)+"-",i=T(f.getDate())+" ",C=T(f.getHours())+":",d=T(f.getMinutes())+":",U=T(f.getSeconds());return _+V+i+C+d+U}function T(N){return N<10?"0"+N:N}const ce={style:{"text-align":"right"}},me={__name:"addSnapshot",props:{open:{type:Boolean,default:!1},snapshotData:{type:Object,default:null}},emits:["close"],setup(N,{emit:f}){P().appContext.config.globalProperties;const V=m(N.open);m(!1);const i=m({snapshotName:"",repositoryName:"",indexList:[],ignore_unavailable:null,include_global_state:null,partial:null,wait:null}),C=m({}),d=m(!1),U=a=>{console.log(a),i.value.indexList=a},M=async()=>{d.value=!0;const a={es_connect:L.GetSelectEsConnID()},{data:r,code:n,msg:v}=await z(a);n===0?C.value=r.res:n===199999?X({title:"Error",dangerouslyUseHTMLString:!0,message:`
        <strong>
          <i style="color: orange">path.repo没有设置</i><br>
          <i>在elasticsearch.yml 配置文件中配置仓库base目录</i><br>
          <i>添加path.repo: /tmp/tmp (/tmp/tmp 为快照备份所在文件夹, <br><i style="color: orange">注意</i>首先要先创建这个文件夹)</i>
        </strong>
      `,type:"error"}):k({type:"error",message:v}),d.value=!1},I=()=>{o("close",!1)},R=async()=>{const a={...i.value,es_connect:L.GetSelectEsConnID()},{code:r,msg:n}=await ae(a);r===0?(o("close",!0),k({type:"success",message:n})):k({type:"error",message:n})},o=f;return K(()=>{M()}),(a,r)=>{const n=u("el-option"),v=u("el-select"),b=u("el-form-item"),A=u("el-input"),l=u("index-select"),s=u("el-form"),y=u("el-button"),$=u("el-card"),p=u("el-dialog");return S(),G("div",null,[e(p,{"close-on-click-modal":!1,modelValue:V.value,"onUpdate:modelValue":r[5]||(r[5]=c=>V.value=c),title:a.$t("创建快照"),onClose:I},{default:t(()=>[e($,{class:"box-card"},{default:t(()=>[e(s,{"label-width":"500px","label-position":"left"},{default:t(()=>[e(b,{label:a.$t("存储库")},{default:t(()=>[e(v,{modelValue:i.value.repositoryName,"onUpdate:modelValue":r[0]||(r[0]=c=>i.value.repositoryName=c),clearable:"",filterable:"",placeholder:a.$t("请选择存储库")},{default:t(()=>[(S(!0),G(Q,null,W(C.value,(c,O,w)=>(S(),B(n,{key:w,label:O,value:O},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),e(b,{label:a.$t("快照名")},{default:t(()=>[e(A,{modelValue:i.value.snapshotName,"onUpdate:modelValue":r[1]||(r[1]=c=>i.value.snapshotName=c),placeholder:a.$t("快照名")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(b,{label:a.$t("需要备份的索引")},{default:t(()=>[e(l,{multiple:!0,"have-all":!0,clearable:!0,style:{width:"210px"},placeholder:a.$t("迁移别名到多个索引上"),onChange:U},null,8,["placeholder"])]),_:1},8,["label"]),e(b,{label:a.$t("include_global_state 【通过设置 include_global_state 为false 能够防止 集群的全局状态被作为快照的一部分存储起来】")},{default:t(()=>[e(v,{modelValue:i.value.include_global_state,"onUpdate:modelValue":r[2]||(r[2]=c=>i.value.include_global_state=c),filterable:""},{default:t(()=>[e(n,{label:a.$t("不设置"),value:null},null,8,["label"]),e(n,{label:a.$t("是"),value:!0},null,8,["label"]),e(n,{label:a.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(b,{label:a.$t("partial  【如果快照中的1个或多个索引不是全部主分片都可用，就会导致整个创建快照的过程失败。 通过设置 partial 为 true 可以改变这个行为】")},{default:t(()=>[e(v,{modelValue:i.value.partial,"onUpdate:modelValue":r[3]||(r[3]=c=>i.value.partial=c),clearable:"",filterable:""},{default:t(()=>[e(n,{label:a.$t("不设置"),value:null},null,8,["label"]),e(n,{label:a.$t("是"),value:!0},null,8,["label"]),e(n,{label:a.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(b,{label:a.$t("创建方式")},{default:t(()=>[e(v,{modelValue:i.value.wait,"onUpdate:modelValue":r[4]||(r[4]=c=>i.value.wait=c),clearable:"",filterable:""},{default:t(()=>[e(n,{label:a.$t("不设置"),value:null},null,8,["label"]),e(n,{label:a.$t("异步创建"),value:!0},null,8,["label"]),e(n,{label:a.$t("同步创建"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1}),E("div",ce,[e(y,{type:"danger",onClick:I},{default:t(()=>[h(g(a.$t("取消")),1)]),_:1}),e(y,{type:"primary",onClick:R},{default:t(()=>[h(g(a.$t("确认")),1)]),_:1})])]),_:1})]),_:1},8,["modelValue","title"])])}}},be={style:{"text-align":"right"}},fe={__name:"snapshotRestore",props:{open:{type:Boolean,default:!1},snapshot:{type:String,default:""},repository:{type:String,default:""}},emits:["close"],setup(N,{emit:f}){P().appContext.config.globalProperties;const _=N,V=m(_.snapshot),i=m(_.repository),C=m(_.open);m(!1);const d=m({snapshotName:_.snapshot,repositoryName:_.repository,ignore_unavailable:null,include_global_state:null,partial:null,wait:null,indexList:[],rename_pattern:"",rename_replacement:""}),U=o=>{d.value.indexList=o},M=()=>{R("close",!1)},I=async()=>{const o={...d.value,es_connect:L.GetSelectEsConnID()},{code:a,msg:r}=await oe(o);if(a===0){R("close",!0),k({type:"success",message:r});return}r.includes(" with same name already exists ")?ie.confirm(`错误信息:【${r}】,是否先关闭所有索引再进行恢复快照?`,"警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{const n={es_connect:L.GetSelectEsConnID(),index_name:"*"},v=await de(n);if(v.code!==0){k({type:"error",message:v.msg});return}await I()}).catch(n=>{console.error(n)}):k({type:"error",message:r})},R=f;return J(()=>_.snapshot,o=>{d.value.snapshotName=o}),J(()=>_.repository,o=>{d.value.repositoryName=o}),(o,a)=>{const r=u("el-input"),n=u("el-form-item"),v=u("index-select"),b=u("el-option"),A=u("el-select"),l=u("el-form"),s=u("el-button"),y=u("el-card"),$=u("el-dialog");return S(),G("div",null,[e($,{"close-on-click-modal":!1,modelValue:C.value,"onUpdate:modelValue":a[7]||(a[7]=p=>C.value=p),title:o.$t("恢复备份"),onClose:M},{default:t(()=>[e(y,{class:"box-card"},{default:t(()=>[e(l,{"label-width":"500px","label-position":"left"},{default:t(()=>[e(n,{label:o.$t("仓库名")},{default:t(()=>[e(r,{modelValue:i.value,"onUpdate:modelValue":a[0]||(a[0]=p=>i.value=p),readonly:""},null,8,["modelValue"])]),_:1},8,["label"]),e(n,{label:o.$t("快照名")},{default:t(()=>[e(r,{modelValue:V.value,"onUpdate:modelValue":a[1]||(a[1]=p=>V.value=p),readonly:""},null,8,["modelValue"])]),_:1},8,["label"]),e(n,{label:o.$t("需要备份的索引")},{default:t(()=>[e(v,{multiple:!0,"have-all":!0,clearable:!0,style:{width:"210px"},placeholder:o.$t("迁移别名到多个索引上"),onChange:U},null,8,["placeholder"])]),_:1},8,["label"]),e(n,{label:o.$t("rename_pattern 【正则表达式】")},{default:t(()=>[e(r,{modelValue:d.value.rename_pattern,"onUpdate:modelValue":a[2]||(a[2]=p=>d.value.rename_pattern=p)},null,8,["modelValue"])]),_:1},8,["label"]),e(n,{label:o.$t("rename_replacement 【正则表达式】")},{default:t(()=>[e(r,{modelValue:d.value.rename_replacement,"onUpdate:modelValue":a[3]||(a[3]=p=>d.value.rename_replacement=p)},null,8,["modelValue"])]),_:1},8,["label"]),e(n,{label:o.$t("include_global_state 【通过设置 include_global_state 为false 能够防止 集群的全局状态被作为快照的一部分存储起来】")},{default:t(()=>[e(A,{modelValue:d.value.include_global_state,"onUpdate:modelValue":a[4]||(a[4]=p=>d.value.include_global_state=p),filterable:""},{default:t(()=>[e(b,{label:o.$t("不设置"),value:null},null,8,["label"]),e(b,{label:o.$t("是"),value:!0},null,8,["label"]),e(b,{label:o.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(n,{label:o.$t("partial  【如果快照中的1个或多个索引不是全部主分片都可用，就会导致整个创建快照的过程失败。 通过设置 partial 为 true 可以改变这个行为】")},{default:t(()=>[e(A,{modelValue:d.value.partial,"onUpdate:modelValue":a[5]||(a[5]=p=>d.value.partial=p),clearable:"",filterable:""},{default:t(()=>[e(b,{label:o.$t("不设置"),value:null},null,8,["label"]),e(b,{label:o.$t("是"),value:!0},null,8,["label"]),e(b,{label:o.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(n,{label:o.$t("创建方式")},{default:t(()=>[e(A,{modelValue:d.value.wait,"onUpdate:modelValue":a[6]||(a[6]=p=>d.value.wait=p),clearable:"",filterable:""},{default:t(()=>[e(b,{label:o.$t("不设置"),value:null},null,8,["label"]),e(b,{label:o.$t("异步创建"),value:!0},null,8,["label"]),e(b,{label:o.$t("同步创建"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1}),E("div",be,[e(s,{type:"danger",onClick:M},{default:t(()=>[h(g(o.$t("取消")),1)]),_:1}),e(s,{type:"primary",onClick:I},{default:t(()=>[h(g(o.$t("确认")),1)]),_:1})])]),_:1})]),_:1},8,["modelValue","title"])])}}},ve={class:"app-container"},ge={class:"search-container"},_e={"slot-scope":"scope"},ye={"slot-scope":"scope"},$e={"slot-scope":"scope"},he={"slot-scope":"scope"},we={"slot-scope":"scope"},ke={__name:"snapshot",setup(N){P().appContext.config.globalProperties;const f=m(!1),_=m(!1),V=m(!1),i=m(""),C=m({}),d=m(""),U=m(!1),M=m([]),I=m(""),R=pe(()=>JSON.stringify(I.value,null,"	")),o=async l=>{const s={es_connect:L.GetSelectEsConnID(),snapshot:l,repository:i.value},{data:y,code:$,msg:p}=await ue(s);if($!==0){k.error(p);return}I.value=y.snapshots,U.value=!0,k.success(p)},a=l=>{d.value=l,f.value=!0},r=l=>{_.value=!1,l&&(n(),v())},n=async()=>{V.value=!0;const l={es_connect:L.GetSelectEsConnID()},{data:s,code:y,msg:$}=await z(l);if(y===0)C.value=s.res,Object.keys(C.value).length>0&&(i.value=Object.keys(C.value)[0]),v();else if(y===199999){X({title:"Error",dangerouslyUseHTMLString:!0,message:`
        <strong>
          <i style="color: orange">path.repo没有设置</i><br>
          <i>在elasticsearch.yml 配置文件中配置仓库base目录</i><br>
          <i>添加path.repo: /tmp/tmp (/tmp/tmp 为快照备份所在文件夹, <br><i style="color: orange">注意</i>首先要先创建这个文件夹)</i>
        </strong>
      `,type:"error"}),V.value=!1;return}else k.error($);V.value=!1},v=async()=>{const l={es_connect:L.GetSelectEsConnID(),repository:i.value},{data:s,code:y,msg:$}=await ne(l);if(y!==0){k.error($);return}k.success($),M.value=s},b=async l=>{d.value=l;const s={es_connect:L.GetSelectEsConnID(),repository:i.value,snapshot:l},{data:y,code:$,msg:p}=await re(s);if($!==0){k.error(p);return}I.value=y.snapshots,U.value=!0},A=l=>{l()};return K(()=>{n()}),(l,s)=>{const y=u("el-option"),$=u("el-select"),p=u("el-form-item"),c=u("el-button"),O=u("el-form"),w=u("el-table-column"),j=u("el-tag"),Z=u("el-button-group"),x=u("el-table"),ee=u("json-editor"),le=u("el-drawer");return S(),G("div",ve,[E("div",ge,[e(O,{inline:!0},{default:t(()=>[e(p,null,{default:t(()=>[e($,{modelValue:i.value,"onUpdate:modelValue":s[0]||(s[0]=D=>i.value=D),clearable:"",filterable:"",style:{width:"200px"},placeholder:l.$t("请选择存储库"),loading:V.value,onChange:v},{default:t(()=>[(S(!0),G(Q,null,W(C.value,(D,F,te)=>(S(),B(y,{key:te,label:F,value:F},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1}),e(p,null,{default:t(()=>[e(c,{type:"warning",onClick:s[1]||(s[1]=D=>_.value=!0)},{default:t(()=>[h(g(l.$t("新建快照")),1)]),_:1}),e(c,{type:"success",onClick:v},{default:t(()=>[h(g(l.$t("刷新")),1)]),_:1})]),_:1})]),_:1})]),e(x,{data:M.value},{default:t(()=>[e(w,{label:l.$t("序号"),align:"center",fixed:"",width:"50"},{default:t(()=>[E("template",_e,[h(g(l.scope.$index+1),1)])]),_:1},8,["label"]),e(w,{align:"center",label:l.$t("快照名"),prop:"id",width:"100"},null,8,["label"]),e(w,{align:"center",label:l.$t("备份索引数"),prop:"indices",width:"100"},null,8,["label"]),e(w,{align:"center",label:l.$t("状态"),width:"100"},{default:t(()=>[E("template",ye,[l.scope.row.status=="SUCCESS"?(S(),B(j,{key:0,type:"success"},{default:t(()=>[h(g(l.$t("成功")),1)]),_:1})):l.scope.row.status=="IN_PROGRESS"?(S(),B(j,{key:1,type:"warning"},{default:t(()=>[h(g(l.$t("还在进行中")),1)]),_:1})):(S(),B(j,{key:2},{default:t(()=>[h(g(l.scope.row.status),1)]),_:1}))])]),_:1},8,["label"]),e(w,{align:"center",label:l.$t("开始详细时间"),width:"180"},{default:t(()=>[E("template",$e,[E("div",null,g(H(q)(l.scope.row.start_epoch)),1)])]),_:1},8,["label"]),e(w,{align:"center",label:l.$t("结束详细时间"),width:"180"},{default:t(()=>[E("template",he,[E("div",null,g(H(q)(l.scope.row.end_epoch)),1)])]),_:1},8,["label"]),e(w,{align:"center",label:l.$t("耗费时长"),prop:"duration",width:"120"},null,8,["label"]),e(w,{align:"center",label:l.$t("分片总数"),prop:"total_shards",width:"120"},null,8,["label"]),e(w,{align:"center",label:l.$t("成功分片数"),prop:"successful_shards",width:"120"},null,8,["label"]),e(w,{align:"center",label:l.$t("失败分片数"),prop:"failed_shards",width:"120"},null,8,["label"]),e(w,{align:"center",label:l.$t("操作"),fixed:"right",width:"350"},{default:t(()=>[E("template",we,[e(Z,null,{default:t(()=>[e(c,{type:"success",onClick:s[2]||(s[2]=D=>b(l.scope.row.id))},{default:t(()=>[h(g(l.$t("查看")),1)]),_:1}),e(c,{type:"danger",onClick:s[3]||(s[3]=D=>H(se)(l.scope.row.id))},{default:t(()=>[h(g(l.$t("删除")),1)]),_:1}),e(c,{type:"warning",onClick:s[4]||(s[4]=D=>a(l.scope.row.id))},{default:t(()=>[h(g(l.$t("恢复")),1)]),_:1}),e(c,{type:"primary",onClick:s[5]||(s[5]=D=>o(l.scope.row.id))},{default:t(()=>[h(g(l.$t("状态")),1)]),_:1})]),_:1})])]),_:1},8,["label"])]),_:1},8,["data"]),e(le,{ref:"drawer",title:l.$t("快照详细信息"),"before-close":A,modelValue:U.value,"onUpdate:modelValue":s[7]||(s[7]=D=>U.value=D),direction:"rtl","close-on-press-escape":"","destroy-on-close":"",size:"50%"},{default:t(()=>[e(ee,{value:R.value,"onUpdate:value":s[6]||(s[6]=D=>R.value=D),class:"res-body",styles:"width: 100%",read:!0,title:l.$t("快照详细信息")},null,8,["value","title"])]),_:1},8,["title","modelValue"]),_.value?(S(),B(me,{key:0,open:_.value,onClose:r},null,8,["open"])):Y("",!0),f.value?(S(),B(fe,{key:1,repository:i.value,snapshot:d.value,open:f.value,onClose:l.closeoRestoreDialog},null,8,["repository","snapshot","open","onClose"])):Y("",!0)])}}};export{ke as default};
