import{b as q,c as ne,d as se,e as ue,f as re,g as ie,h as de}from"./es-backup-4537386f.js";import{f as b,h as K,i as Q,r as i,o as C,c as T,a as e,w as l,j as h,t as g,F as W,v as X,b as L,k as I,J as Z,E as $,O as z,P as pe,g as ce,m as H,y as F,u as P}from"./index-fa15ecb5.js";import{I as x}from"./select-f1971a9d.js";import{d as me}from"./es-index-a89245ce.js";import{J as be}from"./index-5e251ebd.js";import"./_plugin-vue_export-helper-c27b6911.js";function Y(S){var f=new Date(S*1e3);const _=f.getFullYear()+"-",w=(f.getMonth()+1<10?"0"+(f.getMonth()+1):f.getMonth()+1)+"-",r=J(f.getDate())+" ",V=J(f.getHours())+":",p=J(f.getMinutes())+":",k=J(f.getSeconds());return _+w+r+V+p+k}function J(S){return S<10?"0"+S:S}const fe={__name:"addSnapshot",props:{open:{type:Boolean,default:!1},snapshotData:{type:Object,default:null}},emits:["close"],setup(S,{emit:f}){const w=b(S.open);b(!1);const r=b({snapshotName:"",repositoryName:"",indexList:[],ignore_unavailable:null,include_global_state:null,partial:null,wait:null}),V=b({}),p=b(!1),k=t=>{console.log(t),r.value.indexList=t},A=async()=>{p.value=!0;const t={es_connect:I.sdk.GetSelectEsConnID()},{data:u,code:s,msg:c}=await q(t);s===0?V.value=u.res:s===199999?Z({title:"Error",dangerouslyUseHTMLString:!0,message:`
        <strong>
          <i style="color: orange">path.repo没有设置</i><br>
          <i>在elasticsearch.yml 配置文件中配置仓库base目录</i><br>
          <i>添加path.repo: /tmp/tmp (/tmp/tmp 为快照备份所在文件夹, <br><i style="color: orange">注意</i>首先要先创建这个文件夹)</i>
        </strong>
      `,type:"error"}):$({type:"error",message:c}),p.value=!1},N=()=>{n("close",!1)},G=async()=>{const t={...r.value,es_connect:I.sdk.GetSelectEsConnID()},{code:u,msg:s}=await ne(t);u===0?(n("close",!0),$({type:"success",message:s})):$({type:"error",message:s})},n=f;return K(()=>{console.log("addSnapshot mounted"),A()}),Q(()=>{console.log("addSnapshot activated")}),(t,u)=>{const s=i("el-option"),c=i("el-select"),y=i("el-form-item"),U=i("el-input"),M=i("el-form"),R=i("el-button"),a=i("el-card"),o=i("el-drawer");return C(),T("div",null,[e(o,{size:"80%",modelValue:w.value,"onUpdate:modelValue":u[5]||(u[5]=d=>w.value=d),title:t.$t("创建快照"),onClose:N},{default:l(()=>[e(a,{class:"box-card"},{footer:l(()=>[e(R,{type:"danger",onClick:N},{default:l(()=>[h(g(t.$t("取消")),1)]),_:1}),e(R,{type:"primary",onClick:G},{default:l(()=>[h(g(t.$t("确认")),1)]),_:1})]),default:l(()=>[e(M,{"label-width":"500px","label-position":"left"},{default:l(()=>[e(y,{label:t.$t("存储库")},{default:l(()=>[e(c,{modelValue:r.value.repositoryName,"onUpdate:modelValue":u[0]||(u[0]=d=>r.value.repositoryName=d),clearable:"",filterable:"",placeholder:t.$t("请选择存储库")},{default:l(()=>[(C(!0),T(W,null,X(V.value,(d,v,E)=>(C(),L(s,{key:E,label:v,value:v},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),e(y,{label:t.$t("快照名")},{default:l(()=>[e(U,{modelValue:r.value.snapshotName,"onUpdate:modelValue":u[1]||(u[1]=d=>r.value.snapshotName=d),placeholder:t.$t("快照名")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(y,{label:t.$t("需要备份的索引")},{default:l(()=>[e(x,{multiple:!0,"have-all":!0,clearable:!0,style:{width:"210px"},placeholder:t.$t("需要备份的索引"),onChange:k},null,8,["placeholder"])]),_:1},8,["label"]),e(y,{label:t.$t("include_global_state 【通过设置 include_global_state 为false 能够防止 集群的全局状态被作为快照的一部分存储起来】")},{default:l(()=>[e(c,{modelValue:r.value.include_global_state,"onUpdate:modelValue":u[2]||(u[2]=d=>r.value.include_global_state=d),filterable:""},{default:l(()=>[e(s,{label:t.$t("不设置"),value:null},null,8,["label"]),e(s,{label:t.$t("是"),value:!0},null,8,["label"]),e(s,{label:t.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(y,{label:t.$t("partial  【如果快照中的1个或多个索引不是全部主分片都可用，就会导致整个创建快照的过程失败。 通过设置 partial 为 true 可以改变这个行为】")},{default:l(()=>[e(c,{modelValue:r.value.partial,"onUpdate:modelValue":u[3]||(u[3]=d=>r.value.partial=d),clearable:"",filterable:""},{default:l(()=>[e(s,{label:t.$t("不设置"),value:null},null,8,["label"]),e(s,{label:t.$t("是"),value:!0},null,8,["label"]),e(s,{label:t.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(y,{label:t.$t("创建方式")},{default:l(()=>[e(c,{modelValue:r.value.wait,"onUpdate:modelValue":u[4]||(u[4]=d=>r.value.wait=d),clearable:"",filterable:""},{default:l(()=>[e(s,{label:t.$t("不设置"),value:null},null,8,["label"]),e(s,{label:t.$t("异步创建"),value:!0},null,8,["label"]),e(s,{label:t.$t("同步创建"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])}}},ve={__name:"snapshotRestore",props:{open:{type:Boolean,default:!1},snapshot:{type:String,default:""},repository:{type:String,default:""}},emits:["close"],setup(S,{emit:f}){const _=S,w=b(_.snapshot),r=b(_.repository),V=b(_.open);b(!1);const p=b({snapshotName:_.snapshot,repositoryName:_.repository,ignore_unavailable:null,include_global_state:null,partial:null,wait:null,indexList:[],rename_pattern:"",rename_replacement:""}),k=n=>{p.value.indexList=n},A=()=>{G("close",!1)},N=async()=>{const n={...p.value,es_connect:I.sdk.GetSelectEsConnID()},{code:t,msg:u}=await se(n);if(t===0){G("close",!0),$({type:"success",message:u});return}u.includes(" with same name already exists ")?pe.confirm(`错误信息:【${u}】,是否先关闭所有索引再进行恢复快照?`,"警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{const s={es_connect:I.sdk.GetSelectEsConnID(),index_name:"*"},c=await me(s);if(c.code!==0){$({type:"error",message:c.msg});return}await N()}).catch(s=>{console.error(s)}):$({type:"error",message:u})},G=f;return z(()=>_.snapshot,n=>{p.value.snapshotName=n}),z(()=>_.repository,n=>{p.value.repositoryName=n}),(n,t)=>{const u=i("el-input"),s=i("el-form-item"),c=i("el-option"),y=i("el-select"),U=i("el-form"),M=i("el-button"),R=i("el-card"),a=i("el-drawer");return C(),T("div",null,[e(a,{size:"80%",modelValue:V.value,"onUpdate:modelValue":t[7]||(t[7]=o=>V.value=o),title:n.$t("恢复备份"),onClose:A},{default:l(()=>[e(R,{class:"box-card"},{footer:l(()=>[e(M,{type:"danger",onClick:A},{default:l(()=>[h(g(n.$t("取消")),1)]),_:1}),e(M,{type:"primary",onClick:N},{default:l(()=>[h(g(n.$t("确认")),1)]),_:1})]),default:l(()=>[e(U,{"label-width":"500px","label-position":"left"},{default:l(()=>[e(s,{label:n.$t("仓库名")},{default:l(()=>[e(u,{modelValue:r.value,"onUpdate:modelValue":t[0]||(t[0]=o=>r.value=o),readonly:""},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("快照名")},{default:l(()=>[e(u,{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=o=>w.value=o),readonly:""},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("需要恢复的索引")},{default:l(()=>[e(x,{multiple:!0,"have-all":!0,clearable:!0,style:{width:"210px"},placeholder:n.$t("需要恢复的索引"),onChange:k},null,8,["placeholder"])]),_:1},8,["label"]),e(s,{label:n.$t("rename_pattern 【正则表达式】")},{default:l(()=>[e(u,{modelValue:p.value.rename_pattern,"onUpdate:modelValue":t[2]||(t[2]=o=>p.value.rename_pattern=o)},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("rename_replacement 【正则表达式】")},{default:l(()=>[e(u,{modelValue:p.value.rename_replacement,"onUpdate:modelValue":t[3]||(t[3]=o=>p.value.rename_replacement=o)},null,8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("include_global_state 【通过设置 include_global_state 为false 能够防止 集群的全局状态被作为快照的一部分存储起来】")},{default:l(()=>[e(y,{modelValue:p.value.include_global_state,"onUpdate:modelValue":t[4]||(t[4]=o=>p.value.include_global_state=o),filterable:""},{default:l(()=>[e(c,{label:n.$t("不设置"),value:null},null,8,["label"]),e(c,{label:n.$t("是"),value:!0},null,8,["label"]),e(c,{label:n.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("partial  【如果快照中的1个或多个索引不是全部主分片都可用，就会导致整个创建快照的过程失败。 通过设置 partial 为 true 可以改变这个行为】")},{default:l(()=>[e(y,{modelValue:p.value.partial,"onUpdate:modelValue":t[5]||(t[5]=o=>p.value.partial=o),clearable:"",filterable:""},{default:l(()=>[e(c,{label:n.$t("不设置"),value:null},null,8,["label"]),e(c,{label:n.$t("是"),value:!0},null,8,["label"]),e(c,{label:n.$t("否"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),e(s,{label:n.$t("创建方式")},{default:l(()=>[e(y,{modelValue:p.value.wait,"onUpdate:modelValue":t[6]||(t[6]=o=>p.value.wait=o),clearable:"",filterable:""},{default:l(()=>[e(c,{label:n.$t("不设置"),value:null},null,8,["label"]),e(c,{label:n.$t("异步创建"),value:!0},null,8,["label"]),e(c,{label:n.$t("同步创建"),value:!1},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])}}},_e={class:"app-container"},ge={class:"search-container"},Se={__name:"snapshot",setup(S){const f=b(!1),_=b(!1),w=b(!1),r=b(""),V=b({}),p=b(""),k=b(!1),A=b([]),N=b(""),G=ce(()=>JSON.stringify(N.value,null,"	")),n=()=>{f.value=!1},t=async a=>{const o={es_connect:I.sdk.GetSelectEsConnID(),snapshot:a,repository:r.value},{data:d,code:v,msg:E}=await re(o);if(v!==0){$.error(E);return}N.value=d.snapshots,k.value=!0,$.success(E)},u=a=>{p.value=a,f.value=!0},s=async a=>{const o={es_connect:I.sdk.GetSelectEsConnID(),snapshot:a,repository:r.value},{code:d,msg:v}=await ie(o);if(d!==0){$.error(v);return}y(),U(),$.success(v)},c=a=>{_.value=!1,a&&(y(),U())},y=async()=>{w.value=!0;const a={es_connect:I.sdk.GetSelectEsConnID()},{data:o,code:d,msg:v}=await q(a);if(d===0)V.value=o.res,Object.keys(V.value).length>0&&(r.value=Object.keys(V.value)[0]),U();else if(d===199999){Z({title:"Error",dangerouslyUseHTMLString:!0,message:`
        <strong>
          <i style="color: orange">path.repo没有设置</i><br>
          <i>在elasticsearch.yml 配置文件中配置仓库base目录</i><br>
          <i>添加path.repo: /tmp/tmp (/tmp/tmp 为快照备份所在文件夹, <br><i style="color: orange">注意</i>首先要先创建这个文件夹)</i>
        </strong>
      `,type:"error"}),w.value=!1;return}else $.error(v);w.value=!1},U=async()=>{const a={es_connect:I.sdk.GetSelectEsConnID(),repository:r.value},{data:o,code:d,msg:v}=await ue(a);if(d!==0){$.error(v);return}$.success(v),A.value=o},M=async a=>{p.value=a;const o={es_connect:I.sdk.GetSelectEsConnID(),repository:r.value,snapshot:a},{data:d,code:v,msg:E}=await de(o);if(v!==0){$.error(E);return}N.value=d.snapshots,k.value=!0},R=a=>{a()};return K(()=>{console.log("snapshot mounted"),y()}),Q(()=>{console.log("snapshot activated")}),(a,o)=>{const d=i("el-option"),v=i("el-select"),E=i("el-form-item"),B=i("el-button"),ee=i("el-form"),D=i("el-table-column"),j=i("el-tag"),le=i("el-button-group"),te=i("el-table"),ae=i("el-drawer");return C(),T("div",_e,[H("div",ge,[e(ee,{inline:!0},{default:l(()=>[e(E,null,{default:l(()=>[e(v,{modelValue:r.value,"onUpdate:modelValue":o[0]||(o[0]=m=>r.value=m),clearable:"",filterable:"",style:{width:"200px"},placeholder:a.$t("请选择存储库"),loading:w.value,onChange:U},{default:l(()=>[(C(!0),T(W,null,X(V.value,(m,O,oe)=>(C(),L(d,{key:oe,label:O,value:O},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1}),e(E,null,{default:l(()=>[e(B,{type:"warning",onClick:o[1]||(o[1]=m=>_.value=!0)},{default:l(()=>[h(g(a.$t("新建快照")),1)]),_:1}),e(B,{type:"success",onClick:U},{default:l(()=>[h(g(a.$t("刷新")),1)]),_:1})]),_:1})]),_:1})]),e(te,{data:A.value},{default:l(()=>[e(D,{align:"center",label:a.$t("快照名"),prop:"id"},null,8,["label"]),e(D,{align:"center",label:a.$t("备份索引数"),prop:"indices",width:"100"},null,8,["label"]),e(D,{align:"center",label:a.$t("状态"),width:"100"},{default:l(m=>[m.row.status=="SUCCESS"?(C(),L(j,{key:0,type:"success"},{default:l(()=>[h(g(a.$t("成功")),1)]),_:1})):m.row.status=="IN_PROGRESS"?(C(),L(j,{key:1,type:"warning"},{default:l(()=>[h(g(a.$t("还在进行中")),1)]),_:1})):(C(),L(j,{key:2},{default:l(()=>[h(g(m.row.status),1)]),_:2},1024))]),_:1},8,["label"]),e(D,{align:"center",label:a.$t("开始详细时间"),width:"180"},{default:l(m=>[H("div",null,g(P(Y)(m.row.start_epoch)),1)]),_:1},8,["label"]),e(D,{align:"center",label:a.$t("结束详细时间"),width:"180"},{default:l(m=>[H("div",null,g(P(Y)(m.row.end_epoch)),1)]),_:1},8,["label"]),e(D,{align:"center",label:a.$t("耗费时长"),prop:"duration",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("分片总数"),prop:"total_shards",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("成功分片数"),prop:"successful_shards",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("失败分片数"),prop:"failed_shards",width:"120"},null,8,["label"]),e(D,{align:"center",label:a.$t("操作"),fixed:"right",width:"350"},{default:l(m=>[e(le,null,{default:l(()=>[e(B,{type:"success",onClick:O=>M(m.row.id)},{default:l(()=>[h(g(a.$t("查看")),1)]),_:2},1032,["onClick"]),e(B,{type:"danger",onClick:O=>s(m.row.id)},{default:l(()=>[h(g(a.$t("删除")),1)]),_:2},1032,["onClick"]),e(B,{type:"warning",onClick:O=>u(m.row.id)},{default:l(()=>[h(g(a.$t("恢复")),1)]),_:2},1032,["onClick"]),e(B,{type:"primary",onClick:O=>t(m.row.id)},{default:l(()=>[h(g(a.$t("状态")),1)]),_:2},1032,["onClick"])]),_:2},1024)]),_:1},8,["label"])]),_:1},8,["data"]),e(ae,{ref:"drawer",title:a.$t("快照详细信息"),"before-close":R,modelValue:k.value,"onUpdate:modelValue":o[3]||(o[3]=m=>k.value=m),direction:"rtl","close-on-press-escape":"","destroy-on-close":"",size:"80%"},{default:l(()=>[e(be,{value:G.value,"onUpdate:value":o[2]||(o[2]=m=>G.value=m),class:"res-body",styles:"width: 100%",read:!0,title:a.$t("快照详细信息")},null,8,["value","title"])]),_:1},8,["title","modelValue"]),_.value?(C(),L(fe,{key:0,open:_.value,onClose:c},null,8,["open"])):F("",!0),f.value?(C(),L(ve,{key:1,repository:r.value,snapshot:p.value,open:f.value,onClose:n},null,8,["repository","snapshot","open"])):F("",!0)])}}};export{Se as default};
